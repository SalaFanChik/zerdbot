from aiogram import Router, F
from aiogram.types import Message
from aiogram.fsm.context import FSMContext

from app.utils.texts import answer
from app.db.db import get_user_lang
from app.states.user_state import InfoForm
from app.keyboards.reply import get_main_menu, get_course_back_menu
import re 
from app.utils.create_lead import create_amocrm_lead_and_contact



router = Router()

info_text_ru = """
<b>–û –∫–æ–º–ø–∞–Ω–∏–∏ Zerdeli Online</b>

Zerdeli Online ‚Äî –≤–µ–¥—É—â–∞—è –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–Ω–ª–∞–π–Ω –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∞—è—Å—è –Ω–∞ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–º —Ä–∞–∑–≤–∏—Ç–∏–∏ —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –∫ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é –≤ –ø—Ä–µ—Å—Ç–∏–∂–Ω—ã–µ —É—á–µ–±–Ω—ã–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è. –ú—ã —Å–æ–∑–¥–∞—ë–º –º–æ—â–Ω—É—é –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—É—é —ç–∫–æ—Å–∏—Å—Ç–µ–º—É –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–∫–æ–ª–µ–Ω–∏–π –ª–∏–¥–µ—Ä–æ–≤, –æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö, –æ–ø—ã—Ç–µ –∏ –≤—ã—Å–æ–∫–∏—Ö –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞—Ö.

---

<b>–ù–∞—à–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</b>

üìå –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —ç–ª–∏—Ç–Ω—ã–º —à–∫–æ–ª–∞–º  
–ö—É—Ä—Å—ã –∏ —Ç–µ—Å—Ç—ã –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ –ù–ò–®, –ë–ò–õ, –†–§–ú–ú ‚Äî —Å —É—á—ë—Ç–æ–º –≤—Å–µ—Ö –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤.

üìå –ö—É—Ä—Å—ã –ï–ù–¢ –∏ –æ–ª–∏–º–ø–∏–∞–¥—ã  
–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è —É—Å–ø–µ—à–Ω–æ–π —Å–¥–∞—á–∏ –ï–ù–¢ –∏ —É—á–∞—Å—Ç–∏—è –≤ –ø—Ä–µ–¥–º–µ—Ç–Ω—ã—Ö –æ–ª–∏–º–ø–∏–∞–¥–∞—Ö.

---

<b>–ß—Ç–æ –Ω–∞—Å –æ—Ç–ª–∏—á–∞–µ—Ç</b>

üíª –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞  
üìç –£–¥–æ–±–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –æ–±—É—á–µ–Ω–∏—é –∏–∑ –ª—é–±–æ–π —Ç–æ—á–∫–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ –∏ –∑–∞ –µ–≥–æ –ø—Ä–µ–¥–µ–ª–∞–º–∏.

üë©‚Äçüè´ –õ—É—á—à–∏–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏ —Å—Ç—Ä–∞–Ω—ã  
üèÖ –û–ø—ã—Ç–Ω—ã–µ –ø–µ–¥–∞–≥–æ–≥–∏, –ø–æ–±–µ–¥–∏—Ç–µ–ª–∏ —Ä–µ—Å–ø—É–±–ª–∏–∫–∞–Ω—Å–∫–∏—Ö –æ–ª–∏–º–ø–∏–∞–¥ –∏ –∫–æ–Ω–∫—É—Ä—Å–æ–≤.

üéì –ë–æ–ª–µ–µ 100 000 —É—Å–ø–µ—à–Ω—ã—Ö —É—á–µ–Ω–∏–∫–æ–≤  
–ú—ã –≥–æ—Ä–¥–∏–º—Å—è –Ω–∞—à–∏–º–∏ –≤—ã–ø—É—Å–∫–Ω–∏–∫–∞–º–∏, –ø–æ—Å—Ç—É–ø–∏–≤—à–∏–º–∏ –≤ –ù–ò–®, –ë–ò–õ, –†–§–ú–ú, –∞ —Ç–∞–∫–∂–µ –∑–∞—Ä—É–±–µ–∂–Ω—ã–µ —à–∫–æ–ª—ã –∏ –≤—É–∑—ã.

---

<b>–ù–∞—à–∞ –º–∏—Å—Å–∏—è</b>  
–ú—ã —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–∫–æ–ª–µ–Ω–∏–µ –¥—É–º–∞—é—â–∏—Ö, —É–≤–µ—Ä–µ–Ω–Ω—ã—Ö –≤ —Å–µ–±–µ –∏ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏ —Å–∏–ª—å–Ω—ã—Ö –º–æ–ª–æ–¥—ã—Ö –ª—é–¥–µ–π, –≥–æ—Ç–æ–≤—ã—Ö —Ä–µ—à–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏ —Å—Ç—Ä–æ–∏—Ç—å –±—É–¥—É—â–µ–µ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞.
"""

info_text_kz = """
<b>Zerdeli Online –∫–æ–º–ø–∞–Ω–∏—è—Å—ã —Ç—É—Ä–∞–ª—ã</b>

Zerdeli Online ‚Äî “ö–∞–∑–∞“õ—Å—Ç–∞–Ω–¥–∞“ì—ã –∂–µ—Ç–µ–∫—à—ñ –æ–Ω–ª–∞–π–Ω –±—ñ–ª—ñ–º –±–µ—Ä—É –æ—Ä—Ç–∞–ª—ã“ì—ã. –ë—ñ–∑ –æ“õ—É—à—ã–ª–∞—Ä–¥—ã“£ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª–¥—ã“õ –¥–∞–º—É—ã–Ω–∞ –∂”ô–Ω–µ –ù–ò–®, –ë–ò–õ, –†–§–ú–ú —Å–∏—è“õ—Ç—ã “Ø–∑–¥—ñ–∫ –º–µ–∫—Ç–µ–ø—Ç–µ—Ä–≥–µ –¥–∞–π—ã–Ω–¥–∞–ª—É—ã–Ω–∞ –∫”©–º–µ–∫—Ç–µ—Å–µ–º—ñ–∑. –ë—ñ–∑–¥—ñ“£ –º–∞“õ—Å–∞—Ç—ã–º—ã–∑ ‚Äî –∂–∞“£–∞ –±—É—ã–Ω –∫”©—à–±–∞—Å—à—ã–ª–∞—Ä—ã–Ω–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–ª—ã“õ, —Ç”ô–∂—ñ—Ä–∏–±–µ–ª—ñ–∫ –∂”ô–Ω–µ –∂–æ“ì–∞—Ä—ã –∞–∫–∞–¥–µ–º–∏—è–ª—ã“õ –¥–µ“£–≥–µ–π–¥–µ–≥—ñ –±—ñ–ª—ñ–º –±–µ—Ä—É —ç–∫–æ–∂“Ø–π–µ—Å—ñ–Ω “õ“±—Ä—É.

---

<b>–ë—ñ–∑–¥—ñ“£ –±–∞“ì—ã—Ç—Ç–∞—Ä</b>

üìå –≠–ª–∏—Ç–∞–ª—ã“õ –º–µ–∫—Ç–µ–ø—Ç–µ—Ä–≥–µ –¥–∞–π—ã–Ω–¥—ã“õ  
–ù–ò–®, –ë–ò–õ, –†–§–ú–ú –µ–º—Ç–∏—Ö–∞–Ω–¥–∞—Ä—ã–Ω–∞ —Ç–æ–ª—ã“õ –∫—É—Ä—Å –∂”ô–Ω–µ —Ç–µ—Å—Ç—ñ–ª–µ—Ä ‚Äî —Å–æ“£“ì—ã —Ç–∞–ª–∞–ø—Ç–∞—Ä“ì–∞ —Å–∞–π.

üìå “∞–ë–¢ –∂”ô–Ω–µ –æ–ª–∏–º–ø–∏–∞–¥–∞–ª–∞—Ä  
“∞–ë–¢-“ì–∞ –∂”ô–Ω–µ –ø”ô–Ω–¥—ñ–∫ –æ–ª–∏–º–ø–∏–∞–¥–∞–ª–∞—Ä“ì–∞ –∫–µ—à–µ–Ω–¥—ñ –¥–∞–π—ã–Ω–¥—ã“õ.

---

<b>–ê—Ä—Ç—ã“õ—à—ã–ª—ã“õ—Ç–∞—Ä—ã–º—ã–∑</b>

üíª –ó–∞–º–∞–Ω–∞—É–∏ –æ–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞  
üìç “ö–∞–∑–∞“õ—Å—Ç–∞–Ω–Ω—ã“£ –∫–µ–∑ –∫–µ–ª–≥–µ–Ω –Ω“Ø–∫—Ç–µ—Å—ñ–Ω–µ–Ω –æ“õ—É –º“Ø–º–∫—ñ–Ω–¥—ñ–≥—ñ.

üë©‚Äçüè´ –ï–ª—ñ–º—ñ–∑–¥—ñ“£ “Ø–∑–¥—ñ–∫ –º“±“ì–∞–ª—ñ–º–¥–µ—Ä—ñ  
üèÖ –†–µ—Å–ø—É–±–ª–∏–∫–∞–ª—ã“õ –æ–ª–∏–º–ø–∏–∞–¥–∞–ª–∞—Ä–¥—ã“£ –∂–µ“£—ñ–º–ø–∞–∑ “±—Å—Ç–∞–∑–¥–∞—Ä—ã.

üéì 100 000-–Ω–∞–Ω –∞—Å—Ç–∞–º —Ç–∞–±—ã—Å—Ç—ã —Ç“Ø–ª–µ–∫  
–û–ª–∞—Ä –ù–ò–®, –ë–ò–õ, –†–§–ú–ú –∂”ô–Ω–µ —à–µ—Ç–µ–ª–¥—ñ–∫ –º–µ–∫—Ç–µ–ø—Ç–µ—Ä–≥–µ, —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—Ç–µ—Ä–≥–µ —Ç“Ø—Å—Ç—ñ.

---

<b>–ë—ñ–∑–¥—ñ“£ –º–∏—Å—Å–∏—è</b>  
–ë—ñ–∑ ”©–∑ –±–æ–ª–∞—à–∞“ì—ã–Ω–∞ —Å–µ–Ω—ñ–º–¥—ñ, —Å—ã–Ω–∏ –æ–π–ª–∞–π—Ç—ã–Ω –∂”ô–Ω–µ –∞–∫–∞–¥–µ–º–∏—è–ª—ã“õ –¥–µ“£–≥–µ–π—ñ –∂–æ“ì–∞—Ä—ã –∂–∞—Å—Ç–∞—Ä–¥—ã “õ–∞–ª—ã–ø—Ç–∞—Å—Ç—ã—Ä–∞–º—ã–∑.
"""

@router.message(F.text.func(lambda text: "–ö—É—Ä—Å" in text or "–∫—É—Ä—Å" in text))
async def handle_course(message: Message, state: FSMContext):
    lang = get_user_lang(message.from_user.id)

    text = info_text_kz if lang == "kz" else info_text_ru
    await message.answer(text, parse_mode="HTML")

    await message.answer(answer["ask_name"][lang], reply_markup=get_course_back_menu(lang))
    await state.set_state(InfoForm.name)

@router.message(F.text.func(lambda text: "–ê—Ä—Ç“õ–∞" in text or "–ù–∞–∑–∞–¥" in text))
async def handle_back(message: Message, state: FSMContext):
    lang = get_user_lang(message.from_user.id)

    await state.clear()

    await message.answer(answer["greeting"][lang], reply_markup=get_main_menu(lang))

@router.message(InfoForm.name)
async def process_name_course(message: Message, state: FSMContext):
    await state.update_data(name=message.text)
    lang = get_user_lang(message.from_user.id)
    await message.answer(answer["ask_region"][lang])
    await state.set_state(InfoForm.region)

@router.message(InfoForm.region)
async def process_region_course(message: Message, state: FSMContext):
    lang = get_user_lang(message.from_user.id)
    
    if not re.fullmatch(r"[–ê-–Ø–∞-—è”ò”ô”®”©“ö“õ“∞“±“Æ“Ø–Ü—ñ–Å—ë\s\-]+", message.text):
        await message.answer("‚ùó ”®—Ç—ñ–Ω–µ–º—ñ–∑, –æ–±–ª—ã—Å –∞—Ç–∞—É—ã–Ω —Ç–µ–∫ ”ô—Ä—ñ–ø—Ç–µ—Ä–º–µ–Ω –∂–∞–∑—ã“£—ã–∑.")
        return

    await state.update_data(region=message.text)
    await message.answer(answer["ask_phone"][lang])
    await state.set_state(InfoForm.phone)

@router.message(InfoForm.phone)
async def process_phone_course(message: Message, state: FSMContext):
    lang = get_user_lang(message.from_user.id)
    phone = message.text.strip()

    # –í–∞–ª–∏–¥–∞—Ç–æ—Ä –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–æ–≥–æ –Ω–æ–º–µ—Ä–∞
    if not re.fullmatch(r"(\+7|8)\d{10}", phone):
        await message.answer("üìµ –¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ “õ–∞—Ç–µ. –ú—ã—Å–∞–ª—ã: +77001234567 –Ω–µ–º–µ—Å–µ 87001234567")
        return

    await state.update_data(phone=phone)
    data = await state.get_data()

    # –í—ã–∑–æ–≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏ –∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞
    success, result = await create_amocrm_lead_and_contact(
        name=data.get("name"),
        phone=data.get("phone"),
        region=data.get("region")
    )

    if success:
        await message.answer(answer["thank_you"][lang], reply_markup=get_main_menu(lang))
    else:
        await message.answer("‚ùó “ö–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã. ”®—Ç—ñ–Ω—ñ—à –∫–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.")
        print(result)  # –î–ª—è –ª–æ–≥–æ–≤, –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª

    await state.clear()